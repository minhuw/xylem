{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ProfileConfig",
  "description": "Top-level profile configuration",
  "type": "object",
  "properties": {
    "experiment": {
      "$ref": "#/$defs/ExperimentConfig"
    },
    "output": {
      "$ref": "#/$defs/OutputConfig"
    },
    "target": {
      "$ref": "#/$defs/TargetConfig"
    },
    "traffic_groups": {
      "description": "Traffic groups configuration",
      "type": "array",
      "items": {
        "$ref": "#/$defs/TrafficGroupConfig"
      }
    },
    "workload": {
      "$ref": "#/$defs/WorkloadConfig"
    }
  },
  "required": [
    "experiment",
    "target",
    "workload",
    "traffic_groups",
    "output"
  ],
  "$defs": {
    "ExperimentConfig": {
      "description": "Experiment metadata",
      "type": "object",
      "properties": {
        "description": {
          "description": "Optional description",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "duration": {
          "description": "Experiment duration",
          "type": "string"
        },
        "name": {
          "description": "Experiment name",
          "type": "string"
        },
        "seed": {
          "description": "Random seed for reproducibility (None = use entropy)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "default": null,
          "minimum": 0
        }
      },
      "required": [
        "name",
        "duration"
      ]
    },
    "KeysConfig": {
      "description": "Key generation configuration (SPATIAL level)",
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "start": {
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "strategy": {
              "type": "string",
              "const": "sequential"
            },
            "value_size": {
              "type": "integer",
              "format": "uint",
              "minimum": 0
            }
          },
          "required": [
            "strategy",
            "start",
            "value_size"
          ]
        },
        {
          "type": "object",
          "properties": {
            "max": {
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "strategy": {
              "type": "string",
              "const": "random"
            },
            "value_size": {
              "type": "integer",
              "format": "uint",
              "minimum": 0
            }
          },
          "required": [
            "strategy",
            "max",
            "value_size"
          ]
        },
        {
          "type": "object",
          "properties": {
            "max": {
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "strategy": {
              "type": "string",
              "const": "round-robin"
            },
            "value_size": {
              "type": "integer",
              "format": "uint",
              "minimum": 0
            }
          },
          "required": [
            "strategy",
            "max",
            "value_size"
          ]
        },
        {
          "type": "object",
          "properties": {
            "n": {
              "description": "Number of keys in range [0, n-1]",
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "strategy": {
              "type": "string",
              "const": "zipfian"
            },
            "theta": {
              "description": "Exponent (theta) controlling skewness",
              "type": "number",
              "format": "double"
            },
            "value_size": {
              "type": "integer",
              "format": "uint",
              "minimum": 0
            }
          },
          "required": [
            "strategy",
            "n",
            "theta",
            "value_size"
          ]
        }
      ]
    },
    "LoadPatternConfig": {
      "description": "Load pattern configuration (MACRO level - time-varying traffic)",
      "oneOf": [
        {
          "type": "object",
          "properties": {
            "rate": {
              "description": "Requests per second",
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "constant"
            }
          },
          "required": [
            "type",
            "rate"
          ]
        },
        {
          "type": "object",
          "properties": {
            "duration": {
              "type": "string"
            },
            "end_rate": {
              "type": "number",
              "format": "double"
            },
            "start_rate": {
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "ramp"
            }
          },
          "required": [
            "type",
            "start_rate",
            "end_rate",
            "duration"
          ]
        },
        {
          "type": "object",
          "properties": {
            "normal_rate": {
              "type": "number",
              "format": "double"
            },
            "spike_duration": {
              "type": "string"
            },
            "spike_rate": {
              "type": "number",
              "format": "double"
            },
            "spike_start": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "spike"
            }
          },
          "required": [
            "type",
            "normal_rate",
            "spike_rate",
            "spike_start",
            "spike_duration"
          ]
        },
        {
          "type": "object",
          "properties": {
            "amplitude": {
              "type": "number",
              "format": "double"
            },
            "base_rate": {
              "type": "number",
              "format": "double"
            },
            "period": {
              "type": "string"
            },
            "phase_shift": {
              "type": [
                "string",
                "null"
              ],
              "default": null
            },
            "type": {
              "type": "string",
              "const": "sinusoidal"
            }
          },
          "required": [
            "type",
            "base_rate",
            "amplitude",
            "period"
          ]
        },
        {
          "type": "object",
          "properties": {
            "steps": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/StepConfig"
              }
            },
            "type": {
              "type": "string",
              "const": "step"
            }
          },
          "required": [
            "type",
            "steps"
          ]
        },
        {
          "type": "object",
          "properties": {
            "max_rate": {
              "type": "number",
              "format": "double"
            },
            "min_rate": {
              "type": "number",
              "format": "double"
            },
            "period": {
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "sawtooth"
            }
          },
          "required": [
            "type",
            "min_rate",
            "max_rate",
            "period"
          ]
        }
      ]
    },
    "OutputConfig": {
      "description": "Output configuration",
      "type": "object",
      "properties": {
        "file": {
          "description": "Output file path",
          "type": "string"
        },
        "format": {
          "description": "Output format: json, csv",
          "type": "string",
          "default": "json"
        },
        "real_time": {
          "description": "Print real-time updates",
          "type": "boolean",
          "default": false
        }
      },
      "required": [
        "file"
      ]
    },
    "PolicyConfig": {
      "description": "Policy configuration for traffic groups",
      "oneOf": [
        {
          "description": "Closed-loop policy (max throughput)",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "closed-loop"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Fixed-rate policy",
          "type": "object",
          "properties": {
            "rate": {
              "description": "Rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "fixed-rate"
            }
          },
          "required": [
            "type",
            "rate"
          ]
        },
        {
          "description": "Poisson policy",
          "type": "object",
          "properties": {
            "rate": {
              "description": "Average rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "poisson"
            }
          },
          "required": [
            "type",
            "rate"
          ]
        },
        {
          "description": "Adaptive policy",
          "type": "object",
          "properties": {
            "initial_rate": {
              "description": "Initial rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "max_rate": {
              "description": "Maximum rate (cap)",
              "type": "number",
              "format": "double",
              "default": 10000000.0
            },
            "min_rate": {
              "description": "Minimum rate (fallback)",
              "type": "number",
              "format": "double",
              "default": 100.0
            },
            "target_latency_us": {
              "description": "Target latency in microseconds",
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "adaptive"
            }
          },
          "required": [
            "type",
            "initial_rate",
            "target_latency_us"
          ]
        }
      ]
    },
    "SamplingPolicy": {
      "description": "Sampling policy configuration for latency measurement",
      "oneOf": [
        {
          "description": "Limited sampling with fixed rate and max samples",
          "type": "object",
          "properties": {
            "max_samples": {
              "description": "Maximum number of samples to store",
              "type": "integer",
              "format": "uint",
              "default": 131072,
              "minimum": 0
            },
            "rate": {
              "description": "Sampling rate (0.0 to 1.0)",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "type": {
              "type": "string",
              "const": "limited"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Zero sampling: record every latency (unlimited storage)\nWARNING: Can consume large amounts of memory for high-throughput workloads",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "unlimited"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Adaptive sampling: dynamically adjust rate to maintain target CI width",
          "type": "object",
          "properties": {
            "initial_rate": {
              "description": "Initial sampling rate",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "max_rate": {
              "description": "Maximum sampling rate",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "max_samples": {
              "description": "Maximum number of samples to store",
              "type": "integer",
              "format": "uint",
              "default": 131072,
              "minimum": 0
            },
            "min_rate": {
              "description": "Minimum sampling rate",
              "type": "number",
              "format": "double",
              "default": 0.001
            },
            "target_ci_width_us": {
              "description": "Target confidence interval width (in microseconds)",
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "adaptive"
            }
          },
          "required": [
            "type",
            "target_ci_width_us"
          ]
        },
        {
          "description": "DDSketch: Distributed quantile sketch with relative-error guarantees\nMemory-efficient and fully mergeable across traffic groups",
          "type": "object",
          "properties": {
            "alpha": {
              "description": "Relative accuracy parameter (e.g., 0.01 = 1% error)",
              "type": "number",
              "format": "double",
              "default": 0.01
            },
            "max_bins": {
              "description": "Maximum number of bins (in steps of 128)",
              "type": "integer",
              "format": "uint32",
              "default": 1024,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "dd-sketch"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "T-Digest: Adaptive clustering sketch optimized for extreme tail percentiles\nBetter accuracy than DDSketch for p999+, fully mergeable",
          "type": "object",
          "properties": {
            "compression": {
              "description": "Compression parameter (higher = more accurate, more memory)\nTypical values: 100-1000",
              "type": "integer",
              "format": "uint",
              "default": 1000,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "t-digest"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "HDR Histogram: High dynamic range histogram for maximum accuracy\nHigher memory usage but excellent for all percentiles",
          "type": "object",
          "properties": {
            "max_value_us": {
              "description": "Maximum expected value (in microseconds)",
              "type": "integer",
              "format": "uint64",
              "default": 3600000000,
              "minimum": 0
            },
            "sigfigs": {
              "description": "Number of significant digits (1-5)\nHigher = more accurate but more memory",
              "type": "integer",
              "format": "uint8",
              "default": 3,
              "maximum": 255,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "hdr-histogram"
            }
          },
          "required": [
            "type"
          ]
        }
      ]
    },
    "StepConfig": {
      "description": "Step configuration for StepPattern",
      "type": "object",
      "properties": {
        "duration": {
          "type": "string"
        },
        "rate": {
          "type": "number",
          "format": "double"
        }
      },
      "required": [
        "duration",
        "rate"
      ]
    },
    "TargetConfig": {
      "description": "Target server configuration",
      "type": "object",
      "properties": {
        "address": {
          "description": "Server address (e.g., \"127.0.0.1:6379\") - can be overridden via CLI",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "protocol": {
          "description": "Default protocol for traffic groups that don't specify their own\nValid: redis, memcached-binary, memcached-ascii, http",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "transport": {
          "description": "Transport: tcp, udp",
          "type": "string",
          "default": "tcp"
        }
      }
    },
    "TrafficGroupConfig": {
      "description": "Traffic group configuration",
      "type": "object",
      "properties": {
        "connections_per_thread": {
          "description": "Number of connections per thread",
          "type": "integer",
          "format": "uint",
          "minimum": 0
        },
        "max_pending_per_connection": {
          "description": "Maximum pending requests per connection",
          "type": "integer",
          "format": "uint",
          "default": 10,
          "minimum": 0
        },
        "name": {
          "description": "Group name for identification",
          "type": "string"
        },
        "policy": {
          "description": "Traffic policy configuration",
          "$ref": "#/$defs/PolicyConfig"
        },
        "protocol": {
          "description": "Protocol for this group (optional, falls back to target.protocol if not specified)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "sampling_policy": {
          "description": "Latency sampling policy",
          "$ref": "#/$defs/SamplingPolicy",
          "default": {
            "max_samples": 131072,
            "rate": 1.0,
            "type": "limited"
          }
        },
        "target": {
          "description": "Target address for this group (optional, falls back to global target if not specified)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "threads": {
          "description": "Thread IDs this group runs on",
          "type": "array",
          "items": {
            "type": "integer",
            "format": "uint",
            "minimum": 0
          }
        }
      },
      "required": [
        "name",
        "threads",
        "connections_per_thread",
        "policy"
      ]
    },
    "WorkloadConfig": {
      "description": "Workload configuration",
      "type": "object",
      "properties": {
        "keys": {
          "description": "Key generation strategy",
          "$ref": "#/$defs/KeysConfig"
        },
        "pattern": {
          "description": "Load pattern (MACRO level - time-varying traffic)",
          "$ref": "#/$defs/LoadPatternConfig"
        }
      },
      "required": [
        "keys",
        "pattern"
      ]
    }
  }
}

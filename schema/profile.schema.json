{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ProfileConfig",
  "description": "Top-level profile configuration",
  "type": "object",
  "properties": {
    "experiment": {
      "$ref": "#/$defs/ExperimentConfig"
    },
    "output": {
      "$ref": "#/$defs/OutputConfig"
    },
    "target": {
      "$ref": "#/$defs/TargetConfig"
    },
    "traffic_groups": {
      "description": "Traffic groups configuration",
      "type": "array",
      "items": {
        "$ref": "#/$defs/TrafficGroupConfig"
      }
    }
  },
  "required": [
    "experiment",
    "target",
    "traffic_groups",
    "output"
  ],
  "$defs": {
    "ExperimentConfig": {
      "description": "Experiment metadata",
      "type": "object",
      "properties": {
        "description": {
          "description": "Optional description",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "duration": {
          "description": "Experiment duration",
          "type": "string"
        },
        "name": {
          "description": "Experiment name",
          "type": "string"
        },
        "seed": {
          "description": "Random seed for reproducibility (None = use entropy)",
          "type": [
            "integer",
            "null"
          ],
          "format": "uint64",
          "default": null,
          "minimum": 0
        }
      },
      "required": [
        "name",
        "duration"
      ]
    },
    "HtmlOutputConfig": {
      "description": "HTML output configuration",
      "type": "object",
      "properties": {
        "library": {
          "description": "Chart library: chartjs or plotly",
          "type": "string",
          "default": "chartjs"
        },
        "theme": {
          "description": "Theme: light or dark",
          "type": "string",
          "default": "light"
        }
      }
    },
    "OutputConfig": {
      "description": "Output configuration",
      "type": "object",
      "properties": {
        "file": {
          "description": "Output file path (for json/html, extensions will be added automatically)",
          "type": "string"
        },
        "format": {
          "description": "Output format: json, html, both, or detailed-json",
          "$ref": "#/$defs/OutputFormat",
          "default": "json"
        },
        "html": {
          "description": "HTML chart configuration",
          "$ref": "#/$defs/HtmlOutputConfig",
          "default": {
            "library": "chartjs",
            "theme": "light"
          }
        },
        "real_time": {
          "description": "Print real-time updates",
          "type": "boolean",
          "default": false
        }
      },
      "required": [
        "file"
      ]
    },
    "OutputFormat": {
      "description": "Output format options",
      "oneOf": [
        {
          "description": "Simple JSON format (backward compatible)",
          "type": "string",
          "const": "json"
        },
        {
          "description": "Detailed JSON with per-group breakdown",
          "type": "string",
          "const": "detailed-json"
        },
        {
          "description": "HTML report with visualizations",
          "type": "string",
          "const": "html"
        },
        {
          "description": "Both detailed JSON and HTML",
          "type": "string",
          "const": "both"
        },
        {
          "description": "Human-readable console output only (no file)",
          "type": "string",
          "const": "human"
        }
      ]
    },
    "PolicyConfig": {
      "description": "Policy configuration for traffic groups",
      "oneOf": [
        {
          "description": "Closed-loop policy (max throughput)",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "closed-loop"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Fixed-rate policy",
          "type": "object",
          "properties": {
            "rate": {
              "description": "Rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "fixed-rate"
            }
          },
          "required": [
            "type",
            "rate"
          ]
        },
        {
          "description": "Poisson policy",
          "type": "object",
          "properties": {
            "rate": {
              "description": "Average rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "type": {
              "type": "string",
              "const": "poisson"
            }
          },
          "required": [
            "type",
            "rate"
          ]
        },
        {
          "description": "Adaptive policy",
          "type": "object",
          "properties": {
            "initial_rate": {
              "description": "Initial rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "max_rate": {
              "description": "Maximum rate (cap)",
              "type": "number",
              "format": "double",
              "default": 10000000.0
            },
            "min_rate": {
              "description": "Minimum rate (fallback)",
              "type": "number",
              "format": "double",
              "default": 100.0
            },
            "target_latency_us": {
              "description": "Target latency in microseconds",
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "adaptive"
            }
          },
          "required": [
            "type",
            "initial_rate",
            "target_latency_us"
          ]
        },
        {
          "description": "Sinusoidal pattern - varies rate following a sine wave (e.g., diurnal patterns)",
          "type": "object",
          "properties": {
            "base_rate": {
              "description": "Base rate (center of oscillation) in requests per second",
              "type": "number",
              "format": "double"
            },
            "amplitude": {
              "description": "Amplitude - how much rate varies above/below base",
              "type": "number",
              "format": "double"
            },
            "period": {
              "description": "Period duration (e.g., \"60s\", \"24h\")",
              "type": "string"
            },
            "phase_shift": {
              "description": "Optional phase shift duration",
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "sinusoidal"
            }
          },
          "required": [
            "type",
            "base_rate",
            "amplitude",
            "period"
          ]
        },
        {
          "description": "Ramp pattern - linearly increase/decrease rate over time",
          "type": "object",
          "properties": {
            "start_rate": {
              "description": "Starting rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "end_rate": {
              "description": "Ending rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "duration": {
              "description": "Ramp duration (e.g., \"60s\")",
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "ramp"
            }
          },
          "required": [
            "type",
            "start_rate",
            "end_rate",
            "duration"
          ]
        },
        {
          "description": "Spike pattern - sudden burst of traffic",
          "type": "object",
          "properties": {
            "normal_rate": {
              "description": "Normal baseline rate in requests per second",
              "type": "number",
              "format": "double"
            },
            "spike_rate": {
              "description": "Peak rate during spike",
              "type": "number",
              "format": "double"
            },
            "spike_start": {
              "description": "When the spike starts (e.g., \"10s\")",
              "type": "string"
            },
            "spike_duration": {
              "description": "How long the spike lasts (e.g., \"5s\")",
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "spike"
            }
          },
          "required": [
            "type",
            "normal_rate",
            "spike_rate",
            "spike_start",
            "spike_duration"
          ]
        },
        {
          "description": "Sawtooth pattern - repeated ramps (ramp up, instant drop, repeat)",
          "type": "object",
          "properties": {
            "min_rate": {
              "description": "Minimum rate (start of ramp)",
              "type": "number",
              "format": "double"
            },
            "max_rate": {
              "description": "Maximum rate (end of ramp)",
              "type": "number",
              "format": "double"
            },
            "period": {
              "description": "Period for one complete cycle (e.g., \"30s\")",
              "type": "string"
            },
            "type": {
              "type": "string",
              "const": "sawtooth"
            }
          },
          "required": [
            "type",
            "min_rate",
            "max_rate",
            "period"
          ]
        }
      ]
    },
    "RedisClusterConfig": {
      "description": "Redis Cluster configuration",
      "type": "object",
      "properties": {
        "nodes": {
          "description": "Cluster nodes with their slot assignments",
          "type": "array",
          "items": {
            "$ref": "#/$defs/RedisClusterNodeConfig"
          }
        }
      },
      "required": [
        "nodes"
      ]
    },
    "RedisClusterNodeConfig": {
      "description": "Redis Cluster node configuration",
      "type": "object",
      "properties": {
        "address": {
          "description": "Node address (e.g., \"127.0.0.1:7000\")",
          "type": "string"
        },
        "slot_end": {
          "description": "End of slot range (0-16383)",
          "type": "integer",
          "format": "uint16",
          "maximum": 65535,
          "minimum": 0
        },
        "slot_start": {
          "description": "Start of slot range (0-16383)",
          "type": "integer",
          "format": "uint16",
          "maximum": 65535,
          "minimum": 0
        }
      },
      "required": [
        "address",
        "slot_start",
        "slot_end"
      ]
    },
    "SamplingPolicy": {
      "description": "Sampling policy configuration for latency measurement",
      "oneOf": [
        {
          "description": "Limited sampling with fixed rate and max samples",
          "type": "object",
          "properties": {
            "max_samples": {
              "description": "Maximum number of samples to store",
              "type": "integer",
              "format": "uint",
              "default": 131072,
              "minimum": 0
            },
            "rate": {
              "description": "Sampling rate (0.0 to 1.0)",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "type": {
              "type": "string",
              "const": "limited"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Zero sampling: record every latency (unlimited storage)\nWARNING: Can consume large amounts of memory for high-throughput workloads",
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "const": "unlimited"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "Adaptive sampling: dynamically adjust rate to maintain target CI width",
          "type": "object",
          "properties": {
            "initial_rate": {
              "description": "Initial sampling rate",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "max_rate": {
              "description": "Maximum sampling rate",
              "type": "number",
              "format": "double",
              "default": 1.0
            },
            "max_samples": {
              "description": "Maximum number of samples to store",
              "type": "integer",
              "format": "uint",
              "default": 131072,
              "minimum": 0
            },
            "min_rate": {
              "description": "Minimum sampling rate",
              "type": "number",
              "format": "double",
              "default": 0.001
            },
            "target_ci_width_us": {
              "description": "Target confidence interval width (in microseconds)",
              "type": "integer",
              "format": "uint64",
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "adaptive"
            }
          },
          "required": [
            "type",
            "target_ci_width_us"
          ]
        },
        {
          "description": "DDSketch: Distributed quantile sketch with relative-error guarantees\nMemory-efficient and fully mergeable across traffic groups",
          "type": "object",
          "properties": {
            "alpha": {
              "description": "Relative accuracy parameter (e.g., 0.01 = 1% error)",
              "type": "number",
              "format": "double",
              "default": 0.01
            },
            "max_bins": {
              "description": "Maximum number of bins (in steps of 128)",
              "type": "integer",
              "format": "uint32",
              "default": 1024,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "dd-sketch"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "T-Digest: Adaptive clustering sketch optimized for extreme tail percentiles\nBetter accuracy than DDSketch for p999+, fully mergeable",
          "type": "object",
          "properties": {
            "compression": {
              "description": "Compression parameter (higher = more accurate, more memory)\nTypical values: 100-1000",
              "type": "integer",
              "format": "uint",
              "default": 1000,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "t-digest"
            }
          },
          "required": [
            "type"
          ]
        },
        {
          "description": "HDR Histogram: High dynamic range histogram for maximum accuracy\nHigher memory usage but excellent for all percentiles",
          "type": "object",
          "properties": {
            "max_value_us": {
              "description": "Maximum expected value (in microseconds)",
              "type": "integer",
              "format": "uint64",
              "default": 3600000000,
              "minimum": 0
            },
            "sigfigs": {
              "description": "Number of significant digits (1-5)\nHigher = more accurate but more memory",
              "type": "integer",
              "format": "uint8",
              "default": 3,
              "maximum": 255,
              "minimum": 0
            },
            "type": {
              "type": "string",
              "const": "hdr-histogram"
            }
          },
          "required": [
            "type"
          ]
        }
      ]
    },
    "TargetConfig": {
      "description": "Target server configuration",
      "type": "object",
      "properties": {
        "address": {
          "description": "Server address (e.g., \"127.0.0.1:6379\") - can be overridden via CLI",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "protocol": {
          "description": "Default protocol for traffic groups that don't specify their own\nValid: redis, redis-cluster, memcached-binary, memcached-ascii, http",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "redis_cluster": {
          "description": "Redis Cluster configuration (only used when protocol = \"redis-cluster\")",
          "anyOf": [
            {
              "$ref": "#/$defs/RedisClusterConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "transport": {
          "description": "Transport: tcp, udp",
          "type": "string",
          "default": "tcp"
        }
      }
    },
    "TrafficGroupConfig": {
      "description": "Traffic group configuration",
      "type": "object",
      "properties": {
        "connections_per_thread": {
          "description": "Number of connections per thread",
          "type": "integer",
          "format": "uint",
          "minimum": 0
        },
        "max_pending_per_connection": {
          "description": "Maximum pending requests per connection",
          "type": "integer",
          "format": "uint",
          "default": 10,
          "minimum": 0
        },
        "name": {
          "description": "Group name for identification",
          "type": "string"
        },
        "protocol": {
          "description": "Protocol for this group (optional, falls back to target.protocol if not specified)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "protocol_config": {
          "description": "Protocol-specific configuration. For Redis/Memcached: contains keys, operations, value_size. For HTTP: contains method, path, host.",
          "type": "object",
          "properties": {
            "keys": {
              "description": "Key generation strategy for key-value protocols",
              "type": "object",
              "properties": {
                "strategy": {
                  "description": "Key distribution: sequential, random, round-robin, zipfian, gaussian",
                  "type": "string",
                  "enum": ["sequential", "random", "round-robin", "zipfian", "gaussian"]
                },
                "n": {
                  "description": "Number of keys for zipfian distribution",
                  "type": "integer",
                  "minimum": 1
                },
                "theta": {
                  "description": "Zipfian exponent (0.99 = typical, higher = more skew)",
                  "type": "number"
                },
                "max": {
                  "description": "Maximum key value for random/round-robin/gaussian",
                  "type": "integer",
                  "minimum": 1
                },
                "start": {
                  "description": "Starting key value for sequential",
                  "type": "integer",
                  "default": 0
                },
                "mean_pct": {
                  "description": "Mean as percentage of keyspace (0.0-1.0) for gaussian",
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 1.0
                },
                "std_dev_pct": {
                  "description": "Standard deviation as percentage of keyspace for gaussian",
                  "type": "number",
                  "minimum": 0.0,
                  "maximum": 1.0
                },
                "value_size": {
                  "description": "Value size in bytes",
                  "type": "integer",
                  "minimum": 1
                }
              },
              "required": ["strategy", "value_size"]
            },
            "operations": {
              "description": "Redis command selection strategy",
              "type": "object",
              "properties": {
                "strategy": {
                  "description": "fixed (single command) or weighted (random selection)",
                  "type": "string",
                  "enum": ["fixed", "weighted"]
                },
                "operation": {
                  "description": "Command name for fixed strategy (get, set, incr, etc.)",
                  "type": "string"
                },
                "commands": {
                  "description": "Array of weighted commands for weighted strategy",
                  "type": "array",
                  "items": {
                    "type": "object",
                    "properties": {
                      "name": {
                        "description": "Command name: get, set, incr, mget, wait, setex, scan, etc.",
                        "type": "string"
                      },
                      "weight": {
                        "description": "Probability weight (0.0-1.0, weights are normalized)",
                        "type": "number",
                        "minimum": 0.0
                      },
                      "params": {
                        "description": "Command-specific parameters",
                        "type": "object",
                        "properties": {
                          "count": { "type": "integer", "description": "Key count for MGET" },
                          "num_replicas": { "type": "integer", "description": "Replica count for WAIT" },
                          "timeout_ms": { "type": "integer", "description": "Timeout for WAIT" }
                        }
                      }
                    },
                    "required": ["name", "weight"]
                  }
                }
              },
              "required": ["strategy"]
            },
            "value_size": {
              "description": "Value size configuration (overrides keys.value_size)",
              "type": "object",
              "properties": {
                "strategy": {
                  "description": "fixed, uniform, or normal",
                  "type": "string",
                  "enum": ["fixed", "uniform", "normal"]
                },
                "size": { "type": "integer", "description": "Size for fixed strategy" },
                "min": { "type": "integer", "description": "Minimum size for uniform/normal" },
                "max": { "type": "integer", "description": "Maximum size for uniform/normal" },
                "mean": { "type": "number", "description": "Mean for normal distribution" },
                "std_dev": { "type": "number", "description": "Standard deviation for normal" }
              },
              "required": ["strategy"]
            },
            "data_import": {
              "description": "Import test data from CSV file",
              "type": "object",
              "properties": {
                "file": { "type": "string", "description": "Path to CSV file" },
                "verification": {
                  "type": "object",
                  "properties": {
                    "mode": { "type": "string", "enum": ["during", "after", "only"] },
                    "sample_rate": { "type": "number", "minimum": 0.0, "maximum": 1.0 }
                  }
                }
              },
              "required": ["file"]
            },
            "method": { "type": "string", "description": "HTTP method (GET, POST, PUT)" },
            "path": { "type": "string", "description": "HTTP request path" },
            "host": { "type": "string", "description": "HTTP Host header" },
            "body_size": { "type": "integer", "description": "HTTP request body size" },
            "operation": { "type": "string", "description": "Memcached operation (GET, SET)" },
            "message_size": { "type": "integer", "description": "Echo message size" }
          },
          "default": null
        },
        "sampling_policy": {
          "description": "Latency sampling policy",
          "$ref": "#/$defs/SamplingPolicy",
          "default": {
            "max_samples": 131072,
            "rate": 1.0,
            "type": "limited"
          }
        },
        "target": {
          "description": "Target address for this group (optional, falls back to global target if not specified)",
          "type": [
            "string",
            "null"
          ],
          "default": null
        },
        "threads": {
          "description": "Thread IDs this group runs on",
          "type": "array",
          "items": {
            "type": "integer",
            "format": "uint",
            "minimum": 0
          }
        },
        "traffic_policy": {
          "description": "Traffic policy configuration (rate control)",
          "$ref": "#/$defs/PolicyConfig"
        }
      },
      "required": [
        "name",
        "threads",
        "connections_per_thread",
        "traffic_policy"
      ]
    }
  }
}
